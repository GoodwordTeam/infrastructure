# Snowflake SQLMesh Integration - Architecture Diagram

## 🏗️ **Current VPC Architecture Overview**

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    AWS US-EAST-2 REGION                                        │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    SNOWFLAKE CLOUD                                             │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                    Snowflake Account: vsc91540.us-east-1                              │   │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐   │   │
│  │  │                    Network Policy: INTEGRATIONS                                │   │   │
│  │  │  ┌─────────────────────────────────────────────────────────────────────────┐   │   │   │
│  │  │  │  ALLOWED IP RANGES (15 total):                                        │   │   │   │
│  │  │  │  • 172.22.0.0/16  (Operations VPC)                                    │   │   │   │
│  │  │  │  • 172.20.0.0/16  (Goodword VPC)                                      │   │   │   │
│  │  │  │  • 100.64.0.0/10  (Tailscale Network)                                 │   │   │   │
│  │  │  │  • 10.0.0.0/8     (Private Networks)                                  │   │   │   │
│  │  │  │  • 172.16.0.0/12  (Private Networks)                                  │   │   │   │
│  │  │  │  • 192.168.0.0/16 (Private Networks)                                  │   │   │   │
│  │  │  │  • Airbyte Cloud US IPs (9 specific IPs)                              │   │   │   │
│  │  │  └─────────────────────────────────────────────────────────────────────────┘   │   │   │
│  │  └─────────────────────────────────────────────────────────────────────────────────┘   │   │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐   │   │
│  │  │                    Database Rules:                                            │   │   │
│  │  │  • GOODWORD_WH.RAW.ANY    (Access to GOODWORD_WH database, RAW schema)      │   │   │
│  │  │  • AIRBYTE_DB.RAW.AIRBYTE (Access to AIRBYTE_DB database, RAW schema)      │   │   │
│  │  └─────────────────────────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    AWS VPCs                                                    │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              OPERATIONS VPC (172.22.0.0/16)                                   │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              PUBLIC SUBNET (172.22.1.0/24)                             │   │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐   │   │
│  │  │                    Access Server (i-07313ed6e2e8bdc1e)                          │   │   │
│  │  │                    IP: 172.22.1.15                                              │   │   │
│  │  │                    Purpose: SSH access, testing, monitoring                      │   │   │
│  │  │                    Security Group: ops-access-server-sg                         │   │   │
│  │  └─────────────────────────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              PRIVATE SUBNET (172.22.2.0/24)                          │   │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐   │   │
│  │  │                    SQLMesh Server (i-03519bd309babd741)                         │   │   │
│  │  │                    IP: 172.22.2.106                                             │   │   │
│  │  │                    Purpose: SQLMesh data transformation server                    │   │   │
│  │  │                    Security Group: ops-sqlmesh-server-sg                          │   │   │
│  │  │                    Installed: SnowSQL, Docker, SQLMesh (Phase 4)                │   │   │
│  │  └─────────────────────────────────────────────────────────────────────────────────┘   │   │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐   │   │
│  │  │                    VPC Endpoint (vpce-06cd22830fe1f953c)                       │   │   │
│  │  │                    Purpose: Private connectivity to Snowflake                   │   │   │
│  │  │                    Security Group: ops-sqlmesh-vpc-endpoint-sg                   │   │   │
│  │  │                    DNS: vpce-06cd22830fe1f953c-iry8z6i2.execute-api.us-east-2.vpce.amazonaws.com │   │   │
│  │  └─────────────────────────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              DATA SUBNETS (172.22.3.0/24, 172.22.4.0/24)            │   │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐   │   │
│  │  │                    PostgreSQL RDS (Aurora PostgreSQL)                           │   │   │
│  │  │                    Purpose: SQLMesh state storage                               │   │   │
│  │  │                    Security Group: ops-database-sg                              │   │   │
│  │  └─────────────────────────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              GOODWORD VPC (172.20.0.0/16)                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              PRIVATE SUBNET (172.20.0.0/24)                          │   │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐   │   │
│  │  │                    VPN Mesh Server (i-03051e6ddd98f5424)                       │   │   │
│  │  │                    IP: 172.20.0.91                                              │   │   │
│  │  │                    Purpose: VPN mesh, cross-VPC communication                    │   │   │
│  │  │                    Security Group: vpn-mesh-server-sg                           │   │   │
│  │  └─────────────────────────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    VPC PEERING                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                    Peering Connection: pcx-093256f9adcfae896                         │   │
│  │                    Status: ACTIVE                                                     │   │
│  │                    Routes: Bidirectional (5 route tables updated)                    │   │
│  │                    Security Groups: Cross-VPC communication enabled                   │   │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    EXTERNAL NETWORKS                                          │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              TAILSCALE NETWORK (100.64.0.0/10)                               │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                    Your Local Machine (via Tailscale)                                │   │   │
│  │                    Access: Operations VPC, Goodword VPC, Snowflake                   │   │   │
│  │                    Tools: SnowSQL, SSH, Web UI                                       │   │   │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              AIRBYTE CLOUD (US IPs)                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                    Airbyte Cloud US IP Addresses:                                    │   │   │
│  │                    • 34.106.109.131, 34.106.196.165, 34.106.60.246                 │   │   │
│  │                    • 34.106.229.69, 34.106.127.139, 34.106.218.58                   │   │   │
│  │                    • 34.106.115.240, 34.106.225.141, 34.33.7.0/29                    │   │   │
│  │                    Purpose: Data pipeline integration with Snowflake                  │   │   │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    CONNECTIVITY FLOW                                          │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              CONNECTIVITY PATHS (All Tested ✅)                               │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │  1. Operations VPC → Snowflake: HTTP 302, Python 200 ✅                              │   │
│  │  2. Goodword VPC → Snowflake: Cross-VPC routes configured ✅                          │   │
│  │  3. Local Machine → Snowflake: SnowSQL working ✅                                     │   │
│  │  4. Airbyte → Snowflake: IP ranges allowed ✅                                        │   │
│  │  5. Operations VPC ↔ Goodword VPC: Bidirectional peering ✅                         │   │
│  │  6. Tailscale → Operations VPC: SSH and web access ✅                                │   │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    SECURITY GROUPS                                            │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              CROSS-VPC SECURITY GROUP RULES                                   │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │  Operations VPC → Goodword VPC: ICMP, TCP 1-65535, UDP 1-65535 ✅                    │   │
│  │  Goodword VPC → Operations VPC: ICMP, TCP 1-65535, UDP 1-65535 ✅                    │   │
│  │  VPC Endpoint Security Group: HTTPS 443 from all allowed networks ✅                  │   │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    PHASE STATUS                                               │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│  ✅ Phase 1: VPC Endpoint Implementation    - COMPLETE                                        │
│  ✅ Phase 2: VPC Peering Configuration     - COMPLETE                                        │
│  ✅ Phase 3: Snowflake Network Policy      - COMPLETE                                        │
│  🚀 Phase 4: SQLMesh Server Setup          - READY FOR DATA ARCHITECT                        │
│  ⏳ Phase 5: End-to-End Testing            - PENDING                                          │
│  ⏳ Phase 6: Security Lockdown (Optional)  - PENDING                                          │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
