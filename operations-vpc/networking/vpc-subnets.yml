# Operations VPC - VPC and Subnets
# This file contains:
# - VPC (ops-vpc) with CIDR 172.22.0.0/16
# - 3 Subnets (public, private, data)
# - Internet Gateway
# - NAT Gateway + Elastic IP
# - Route tables and subnet associations

AWSTemplateFormatVersion: '2010-09-09'
Description: 'Operations VPC - VPC and Subnets'

Parameters:
  KeyPairName:
    Type: AWS::EC2::KeyPair::KeyName
    Default: ops-vpc-key
    Description: Name of the EC2 KeyPair to enable SSH access

Resources:
  # VPC
  OperationsVpc:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 172.22.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: ops-vpc
        - Key: Purpose
          Value: Operations

  # Internet Gateway
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: ops-igw

  # Attach Internet Gateway to VPC
  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref InternetGateway
      VpcId: !Ref OperationsVpc

  # Public Subnet
  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref OperationsVpc
      CidrBlock: 172.22.1.0/24
      AvailabilityZone: us-east-2a
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: ops-public-subnet
        - Key: Type
          Value: Public

  # Private Subnet
  PrivateSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref OperationsVpc
      CidrBlock: 172.22.2.0/24
      AvailabilityZone: us-east-2a
      Tags:
        - Key: Name
          Value: ops-private-subnet
        - Key: Type
          Value: Private

  # Data Subnet (Primary - RDS will deploy here)
  DataSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref OperationsVpc
      CidrBlock: 172.22.3.0/24
      AvailabilityZone: us-east-2a
      Tags:
        - Key: Name
          Value: ops-data-subnet-1
        - Key: Type
          Value: Data

  # Data Subnet 2 (Required by AWS RDS - unused but required)
  DataSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref OperationsVpc
      CidrBlock: 172.22.4.0/24
      AvailabilityZone: us-east-2b
      Tags:
        - Key: Name
          Value: ops-data-subnet-2
        - Key: Type
          Value: Data

  # Elastic IP for NAT Gateway
  NatGatewayEIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: ops-nat-eip

  # NAT Gateway
  NatGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGatewayEIP.AllocationId
      SubnetId: !Ref PublicSubnet
      Tags:
        - Key: Name
          Value: ops-nat-gateway

  # Route Tables
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref OperationsVpc
      Tags:
        - Key: Name
          Value: ops-public-rt

  DefaultPublicRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref OperationsVpc
      Tags:
        - Key: Name
          Value: ops-private-rt

  DefaultPrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway

  # VPC Peering Routes
  PublicPeeringRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 172.20.0.0/16
      VpcPeeringConnectionId: pcx-093256f9adcfae896

  PrivatePeeringRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 172.20.0.0/16
      VpcPeeringConnectionId: pcx-093256f9adcfae896

  # Subnet Route Table Associations
  PublicSubnetAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet
      RouteTableId: !Ref PublicRouteTable

  PrivateSubnetAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet
      RouteTableId: !Ref PrivateRouteTable

  # VPC Endpoint for SQLMesh (Snowflake Integration)
  SQLMeshVPCEndpointSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: VPC Endpoint Security Group for SQLMesh Snowflake Integration
      VpcId: !Ref OperationsVpc
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 172.22.0.0/16
          Description: HTTPS from Operations VPC
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 172.20.0.0/16
          Description: HTTPS from Goodword VPC (future peering)
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 100.64.0.0/10
          Description: HTTPS from Tailscale network
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 10.0.0.0/8
          Description: HTTPS from private networks
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 172.16.0.0/12
          Description: HTTPS from private networks
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 192.168.0.0/16
          Description: HTTPS from private networks
        # Airbyte Cloud US IP addresses
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 34.106.109.131/32
          Description: Airbyte Cloud GCP US West 3
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 34.106.196.165/32
          Description: Airbyte Cloud GCP US West 3
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 34.106.60.246/32
          Description: Airbyte Cloud GCP US West 3
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 34.106.229.69/32
          Description: Airbyte Cloud GCP US West 3
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 34.106.127.139/32
          Description: Airbyte Cloud GCP US West 3
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 34.106.218.58/32
          Description: Airbyte Cloud GCP US West 3
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 34.106.115.240/32
          Description: Airbyte Cloud GCP US West 3
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 34.106.225.141/32
          Description: Airbyte Cloud GCP US West 3
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 34.33.7.0/29
          Description: Airbyte Cloud GCP US Central 1
      Tags:
        - Key: Name
          Value: ops-sqlmesh-vpc-endpoint-sg
        - Key: Purpose
          Value: SQLMesh VPC Endpoint Security

  SQLMeshVPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref OperationsVpc
      ServiceName: com.amazonaws.us-east-2.execute-api
      VpcEndpointType: Interface
      SubnetIds:
        - !Ref PrivateSubnet
      SecurityGroupIds:
        - !Ref SQLMeshVPCEndpointSecurityGroup
      PrivateDnsEnabled: true
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: '*'
            Action: 'execute-api:Invoke'
            Resource: '*'
      Tags:
        - Key: Name
          Value: ops-sqlmesh-vpc-endpoint
        - Key: Purpose
          Value: SQLMesh Snowflake Integration

Outputs:
  VpcId:
    Description: VPC ID
    Value: !Ref OperationsVpc
    Export:
      Name: !Sub '${AWS::StackName}-VpcId'
  
  PublicSubnetId:
    Description: Public Subnet ID
    Value: !Ref PublicSubnet
    Export:
      Name: !Sub '${AWS::StackName}-PublicSubnetId'
  
  PrivateSubnetId:
    Description: Private Subnet ID
    Value: !Ref PrivateSubnet
    Export:
      Name: !Sub '${AWS::StackName}-PrivateSubnetId'
  
  DataSubnet1Id:
    Description: Data Subnet 1 ID (Primary - us-east-2a)
    Value: !Ref DataSubnet
    Export:
      Name: !Sub '${AWS::StackName}-DataSubnet1Id'
  
  DataSubnet2Id:
    Description: Data Subnet 2 ID (Required by AWS - us-east-2b)
    Value: !Ref DataSubnet2
    Export:
      Name: !Sub '${AWS::StackName}-DataSubnet2Id'
  
  NatGatewayId:
    Description: NAT Gateway ID
    Value: !Ref NatGateway
    Export:
      Name: !Sub '${AWS::StackName}-NatGatewayId'
  
  SQLMeshVPCEndpointId:
    Description: SQLMesh VPC Endpoint ID
    Value: !Ref SQLMeshVPCEndpoint
    Export:
      Name: !Sub '${AWS::StackName}-SQLMeshVPCEndpointId'
  
  SQLMeshVPCEndpointSecurityGroupId:
    Description: SQLMesh VPC Endpoint Security Group ID
    Value: !Ref SQLMeshVPCEndpointSecurityGroup
    Export:
      Name: !Sub '${AWS::StackName}-SQLMeshVPCEndpointSecurityGroupId'